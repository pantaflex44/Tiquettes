<?php

/**
 * Tiquettes - Générateur d'étiquettes pour tableaux et armoires électriques
 * Copyright (C) 2024-2025 Christophe LEMOINE
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

declare(strict_types=1);

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require __DIR__ . '/PHPMailer-master/src/Exception.php';
require __DIR__ . '/PHPMailer-master/src/PHPMailer.php';
require __DIR__ . '/PHPMailer-master/src/SMTP.php';


ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);



function dd_json(mixed $content): void
{
    header('Content-Type: application/json');
    write_json([
        'errors' => $content,
    ]);
}

function write_json(mixed $content): void
{
    echo json_encode($content);
    exit;
}

function send_Mail(array|string $to, string $subject, string $body): bool
{
    $mail = new PHPMailer(true);
    try {
        $mail->setLanguage('fr');
        $mail->CharSet = 'UTF-8';
        $mail->Encoding = 'base64';
        $mail->isSMTP();
        $mail->isHTML(true);

        if (defined('SMTP_DEBUG'))
            $mail->SMTPDebug = SMTP_DEBUG;
        if (defined('SMTP_HOST'))
            $mail->Host = SMTP_HOST;
        if (defined('SMTP_AUTH'))
            $mail->SMTPAuth = SMTP_AUTH;
        if (defined('SMTP_USERNAME'))
            $mail->Username = SMTP_USERNAME;
        if (defined('SMTP_PASSWORD'))
            $mail->Password = SMTP_PASSWORD;
        if (defined('SMTP_SECURE'))
            $mail->SMTPSecure = SMTP_SECURE;
        if (defined('SMTP_PORT'))
            $mail->Port = SMTP_PORT;
        if (defined('SMTP_FROM')) {
            if (is_array(SMTP_FROM) && count(SMTP_FROM) === 2) {
                $mail->setFrom(SMTP_FROM[0], SMTP_FROM[1]);
                $mail->addReplyTo(SMTP_FROM[0], SMTP_FROM[1]);
            } else if (is_string(SMTP_FROM)) {
                $mail->setFrom(SMTP_FROM[0], SMTP_FROM[1]);
                $mail->addReplyTo(SMTP_FROM[0], SMTP_FROM[1]);
            }
        }
        if (is_array($to) && count($to) === 2) {
            $mail->addAddress($to[0], $to[1]);
        } else if (is_string($to)) {
            $mail->addAddress($to);
        }

        $mail->Subject = (defined('SMTP_SUBJECT_PREFIX') ? SMTP_SUBJECT_PREFIX : '') . $subject;
        $mail->Body = $body;
        $mail->AltBody = $body;

        $mail->send();
        return true;
    } catch (Exception $e) {
        // $mail->ErrorInfo
        dd_json($mail->ErrorInfo);
        return false;
    }
}

function is_bot()
{
    $bots = [
        "(BOT for JCE)",
        "01h4x.com",
        "360Spider",
        "404checker",
        "404enemy",
        "7Siters",
        "80legs",
        "A6-Indexer",
        "AHC/2.1",
        "AIBOT",
        "ALittle Client",
        "APIs-Google",
        "ASPSeek",
        "Abonti",
        "Aboundex",
        "Acunetix",
        "ADmantX",
        "AdsBot-Google",
        "Adsbot",
        "AfD-Verbotsverfahren",
        "AhrefsBot",
        "AiHitBot",
        "Aipbot",
        "Akkoma",
        "Alexibot",
        "AllSubmitter",
        "Alligator",
        "AlphaBot",
        "Amazonbot",
        "Anarchie",
        "Anarchy",
        "Anarchy99",
        "Ankit",
        "Anthill",
        "Anthropic",
        "Apache-HttpClient/5",
        "ApacheBench",
        "Apexoo",
        "Applebot",
        "AppEngine-Google",
        "ArchiveBot",
        "Arquivo-web-crawler",
        "Aspiegel",
        "Asterias",
        "Astute SRM",
        "Atomseobot",
        "Attach",
        "AwarioBot",
        "AwarioRssBot",
        "AwarioSmartBot",
        "Axios",
        "BBBike",
        "BDCbot",
        "BDFetch",
        "BLEXBot",
        "BTWebClient",
        "BackDoorBot",
        "BackStreet",
        "BackWeb",
        "Backlink-Ceck",
        "BacklinkCrawler",
        "Badass",
        "Baiduspider",
        "Bandit",
        "Barkrowler",
        "BatchFTP",
        "Battleztar Bazinga",
        "BazQuxBot",
        "BehloolBot",
        "BetaBot",
        "Bigfoot",
        "Bingbot",
        "Bitacle",
        "Bitlybot",
        "Black Hole",
        "BlackWidow",
        "Blackboard",
        "Blow",
        "BlowFish",
        "BoardReader",
        "Boardreader",
        "Bolt",
        "BotALot",
        "Brandprotect",
        "Brandwatch",
        "Buck",
        "Buddy",
        "BuiltBotTough",
        "BuiltWith",
        "Bullseye",
        "BunnySlippers",
        "Butterfly",
        "BuzzSumo",
        "Bytespider",
        "CATExplorador",
        "CCBot",
        "CODE87",
        "CSHttp",
        "Calculon",
        "CazoodleBot",
        "Cegbfeieh",
        "CensysInspect",
        "ChatGPT",
        "CHlooe",
        "CheTeam",
        "CheeseBot",
        "CherryPicker",
        "ChinaClaw",
        "Citoid",
        "Claritybot",
        "Claude-Web",
        "Cliqzbot",
        "Cloud mapping",
        "Cloudflare SpeedTest",
        "Coccocbot",
        "Cogentbot",
        "Cohere-ai",
        "Collector",
        "Com.plumanalytics",
        "CommonCrawler",
        "CommonCrawler Node",
        "Copier",
        "CopyRightCheck",
        "Copyscape",
        "Cosmos",
        "Craftbot",
        "Crawl.sogou.com",
        "Crawler.feedback",
        "Crawler4j",
        "Crawling at Home Project",
        "CrazyWebCrawler",
        "Crescent",
        "CriteoBot",
        "CrunchBot",
        "Curious",
        "Curl/7",
        "Custo",
        "CyotekWebCopy",
        "DBLBot",
        "DIIbot",
        "DSearch",
        "DTS Agent",
        "DataCha0s",
        "DataForSeoBot",
        "DatabaseDriverMysqli",
        "Demon",
        "Demandbase-bot",
        "Deusu",
        "Devil",
        "Diffbot",
        "Digincore",
        "DigitalPebble",
        "Dirbuster",
        "Disco",
        "Discobot",
        "Discoverybot",
        "Dispatch",
        "DittoSpyder",
        "Dlvr.it",
        "DnBCrawler-Analytics",
        "DnyzBot",
        "DomCopBot",
        "DomainAppender",
        "DomainCrawler",
        "DomainSigmaCrawler",
        "DomainStatsBot",
        "Domainsproject.org",
        "DotBot",
        "Dotbot",
        "Down/5",
        "Download Wonder",
        "Dragonfly",
        "Drip",
        "DuckDuckBot",
        "DuckDuckGo",
        "ECCP/1.0",
        "EMail Siphon",
        "EMail Wolf",
        "EasyDL",
        "Ebingbong",
        "Ecairn-Grabber",
        "Ecxi",
        "Embedly",
        "EirGrabber",
        "EroCrawler",
        "Ev-crawler",
        "Evil",
        "Exabot",
        "Express WebPictures",
        "ExtLinksBot",
        "Extractor",
        "ExtractorPro",
        "Extreme Picture Finder",
        "EyeNetIE",
        "Ezooms",
        "FDM",
        "FHscan",
        "FacebookBot",
        "FacebookScraper",
        "Feeder",
        "Feedfetcher-Google",
        "Feedly",
        "Feedbot",
        "FemtosearchBot",
        "Fimap",
        "Firefox/7.0",
        "FlashGet",
        "FlipboardProxy",
        "Flunky",
        "Foobot",
        "Freeuploader",
        "Friendica",
        "FrontPage",
        "Fuzz",
        "FyberSpider",
        "Fyrebot",
        "G-i-g-a-b-o-t",
        "GPTBot",
        "GT::WWW",
        "GalaxyBot",
        "GarlikCrawler",
        "Genieo",
        "GermCrawler",
        "GetRight",
        "GetWeb",
        "Getintent",
        "Gigabot",
        "GigablastOpenSource/1.0",
        "Giant Rhubarb",
        "Gluten Free Crawler",
        "Go!Zilla",
        "Go-Ahead-Got-It",
        "Go-http-client",
        "GoZilla",
        "Google Ad monitoring",
        "Google Producer",
        "Google-Apps-Scrip",
        "Google-Extended",
        "Google-InspectionTool",
        "Google-Safety",
        "GoogleOther",
        "Googlebot",
        "Gotit",
        "GrabNet",
        "Grabber",
        "Grafula",
        "GrapeFX",
        "GrapeshotCrawler",
        "GridBot",
        "GroupHigh",
        "Grokkit-crawler",
        "GuzzleHttp",
        "HEADMasterSEO",
        "HMView",
        "HTMLparser",
        "HTTP::Lite",
        "HTTP_Request2",
        "HTTrack",
        "Haansoft",
        "HaosouSpider",
        "Harvest",
        "Havij",
        "Heritrix",
        "Hloader",
        "HonoluluBot",
        "Humanlinks",
        "HybridBot",
        "IABot",
        "IDBTE4M",
        "IDBot",
        "IRLbot",
        "Iblog",
        "Id-search",
        "IlseBot",
        "Image Fetch",
        "Image Sucker",
        "ImageFetcher",
        "ImagesiftBot",
        "InAGist",
        "IndeedBot",
        "Indy Library",
        "InfoNaviRobot",
        "InfoTekies",
        "Instabid",
        "Intelliseek",
        "InterGET",
        "Internet Measurement",
        "Internet Ninja",
        "InternetSeer",
        "InternetVista monitor",
        "Ips-agent",
        "Iria",
        "Iskanie",
        "Isitwp.com",
        "IstellaBot",
        "Iubenda-radar",
        "JOC Web Spider",
        "JamesBOT",
        "Java/1.8",
        "Jbrofuzz",
        "JennyBot",
        "JetCar",
        "Jetty",
        "Jetslide",
        "JikeSpider",
        "Joomla",
        "Jorgee",
        "JustView",
        "Jyxobot",
        "KatBot",
        "Kenjin Spider",
        "Keybot Translation-Search-Machine",
        "Keys-so-bot",
        "Keyword Density",
        "Kinza",
        "Koyu.space",
        "Kozmosbot",
        "Kraken",
        "LCC",
        "LNSpiderguy",
        "LWP::Simple",
        "Lanshanbot",
        "Larbin",
        "Leap",
        "LeechFTP",
        "LeechGet",
        "LexiBot",
        "Lftp",
        "LibWeb",
        "Libwhisker",
        "Libwww-perl",
        "LieBaoFast",
        "Lightspeedsystems",
        "Likse",
        "LinkScan",
        "LinkWalker",
        "Linkbot",
        "Linkdex",
        "Linkdexbot",
        "LinkextractorPro",
        "Linkfluence.com",
        "LinkpadBot",
        "LinksManager",
        "LinqiaMetadataDownloaderBot",
        "LinqiaRSSBot",
        "LinqiaScrapeBot",
        "Lipperhey",
        "Lipperhey Spider",
        "Litemage_walker",
        "LivelapBot",
        "Lmspider",
        "LinkedInBot",
        "Ltx71",
        "Lwp-request",
        "Lwp-trivial",
        "MFC_Tear_Sample",
        "MIDown tool",
        "MIIxpc",
        "MJ12bot",
        "MQQBrowser",
        "MSFrontPage",
        "MSIECrawler",
        "MTRobot",
        "Mag-Net",
        "Magnet",
        "Magpie-crawler",
        "Mail.RU_Bot",
        "Majestic SEO",
        "Majestic-SEO",
        "Majestic12",
        "MarkMonitor",
        "MarkWatch",
        "Mass Downloader",
        "Masscan",
        "Mastodon",
        "Mata Hari",
        "MauiBot",
        "MaxPointCrawler",
        "Mb2345Browser",
        "MeanPath Bot",
        "Meanpathbot",
        "Mediapartners-Google",
        "Mediatoolkitbot",
        "Mediawords",
        "MegaIndex",
        "MetaInspector",
        "MetaJobBot",
        "MetadataScraper",
        "Meta-externalagent",
        "Metauri",
        "MicroMessenger",
        "Microsoft Data Access",
        "Microsoft Office",
        "Microsoft URL Control",
        "Minefield",
        "Miniflux",
        "Mister PiX",
        "Mjukisbyxor",
        "Moblie Safari",
        "Mojeek",
        "Mojolicious",
        "MolokaiBot",
        "Monitoring-plugins",
        "Morfeus Fucking Scanner",
        "Mozlila",
        "Mr.4x3",
        "Msrabot",
        "MuckRack",
        "Muhstik-scan",
        "Musobot",
        "NICErsPRO",
        "NING",
        "NPbot",
        "Name Intelligence",
        "Nameprotect",
        "Navroad",
        "NearSite",
        "Needle",
        "Neevabot",
        "Nessus",
        "NetAnts",
        "NetLyzer",
        "NetMechanic",
        "NetNewsWire",
        "NetSeer crawler",
        "NetSpider",
        "NetVIP",
        "NetZIP",
        "NetaceaBot",
        "Netcraft",
        "NetEstate NE Crawler",
        "Nettrack",
        "Netvibes",
        "NetworkingExtension",
        "NextGenSearchBot",
        "Nibbler",
        "Niki-Bot",
        "Niki-bot",
        "Nikto",
        "NimbleCrawler",
        "Nimbostratus",
        "Ninja",
        "Nmap",
        "Node-fetch",
        "Nuclei",
        "Nutch",
        "Nuzzel",
        "OAI-SearchBot",
        "OBot",
        "Octopus",
        "Offline Explorer",
        "Offline Navigator",
        "Okhttp",
        "Omgili",
        "Omigili",
        "OnCrawl",
        "OnalyticaBot",
        "OpenLinkProfiler",
        "OpenVAS",
        "Openfind",
        "Openvas",
        "OrangeBot",
        "OrangeSpider",
        "OutclicksBot",
        "OutfoxBot",
        "Ows.eu",
        "PECL::HTTP",
        "PHPCrawl",
        "PHP-Curl-Class",
        "POE-Component-Client-HTTP",
        "Pcore-HTTP",
        "Paqlebot",
        "Papa Foto",
        "PaperLiBot",
        "Pavuk",
        "PcBrowser",
        "PeoplePal",
        "PercolateCrawler",
        "PerplexityBot",
        "PetalBot",
        "Petalbot",
        "Petalsearch",
        "PhxBot",
        "Pi-Monster",
        "Picsearch",
        "Picscout",
        "PictureFinder",
        "Piepmatz",
        "Pimonster",
        "Pingdom",
        "Pinterest",
        "Pixray",
        "PleaseCrawl",
        "Pleroma",
        "PocketParser",
        "Pockey",
        "Polaris version",
        "ProPowerBot",
        "ProWebWalker",
        "Probe-image-size",
        "Probethenet",
        "Profound",
        "Protopage",
        "Proximic",
        "Psbot",
        "Pu_iN",
        "PulseCrawler",
        "Pump",
        "PxBroker",
        "PyCurl",
        "Python-requests",
        "Python-urllib",
        "Qwantbot",
        "Qwantify",
        "QueryN Metasearch",
        "QuerySeekerSpider",
        "Quick-Crawler",
        "R6_CommentReader",
        "R6_FeedFetcher",
        "RSSingBot",
        "RankActive",
        "RankActiveLinkBot",
        "RankFlex",
        "RankingBot",
        "RankingBot2",
        "Rankivabot",
        "RankurBot",
        "Re-Animator Bot",
        "Re-re",
        "ReGet",
        "RealDownload",
        "Reaper",
        "RebelMouse",
        "Recorder",
        "RedesScrapy",
        "Reeder",
        "RepoLookoutBot",
        "RepoMonkey",
        "Ripper",
        "RocketCrawler",
        "Rogerbot",
        "SBIder",
        "SEOkicks",
        "SEOlyticsCrawler",
        "SEOprofiler",
        "SEOstats",
        "SISTRIX",
        "SMTBot",
        "SWXCrawler",
        "SalesIntelligent",
        "Scan.lol",
        "ScanAlert",
        "Scanbot",
        "Scalaj-http",
        "Schmorp.de",
        "ScooperBot",
        "ScoutJet",
        "Scrapy",
        "Screaming",
        "ScreenerBot",
        "ScrepyBot",
        "Searchestate",
        "SearchmetricsBot",
        "Seekport",
        "Seekport Crawler",
        "Selfoss",
        "SemanticJuice",
        "SemanticScholarBot",
        "Semanticbot",
        "Semantic-visions.com",
        "Semrush",
        "SemrushBot",
        "SentiBot",
        "Seobility",
        "SeobilityBot",
        "Seocompany.store",
        "Seomoz",
        "Seoscanners",
        "SeoSiteCheckup",
        "Seostar",
        "SerendeputyBot",
        "Serpstatbot",
        "Sexsearcher",
        "SeznamBot",
        "SeznamBot/3.2",
        "SeznamHomepage",
        "Shodan",
        "ShowyouBot",
        "Siphon",
        "SiteCheck",
        "SiteCheckerBotCrawler",
        "SiteChecker.pro",
        "SiteExplorer",
        "SiteLockSpider",
        "SiteSnagger",
        "SiteSucker",
        "Sitebeam",
        "Siteimprove",
        "Siteripz",
        "Sitevigil",
        "Sleuth",
        "SlySearch",
        "SmartDownload",
        "Snake",
        "Snapbot",
        "Snoopy",
        "SocialRankIOBot",
        "Sociscraper",
        "Sogou",
        "Sogou web spider",
        "SogouSpider",
        "Sosospider",
        "Sottopop",
        "SpaceBison",
        "SpaceCowboys",
        "Spammen",
        "SpankBot",
        "Spanner",
        "SpiderLing",
        "SpiderWeb",
        "Spinn3r",
        "Spbot",
        "SputnikBot",
        "Sqlmap",
        "Sqlworm",
        "Sqworm",
        "Steeler",
        "StormCrawler",
        "StractBot",
        "Stripper",
        "Storebot-Google",
        "Sucker",
        "Sucuri",
        "SummalyBot",
        "SuperBot",
        "SuperHTTP",
        "Superfeedr",
        "Surfbot",
        "SurveyBot",
        "Suzuran",
        "Swiftbot",
        "Symfony BrowserKit",
        "Sysomos.com",
        "Sysscan",
        "Szukacz",
        "T0PHackTeam",
        "T8Abot",
        "TTD-Content",
        "TakeOut",
        "Teleport",
        "TeleportPro",
        "Telesoft",
        "Telesphoreo",
        "Telesphorep",
        "TencentTraveler",
        "Terrykyleseoagency.com",
        "The Intraformant",
        "The Knowledge AI",
        "TheNomad",
        "Thumbor",
        "TightTwatBot",
        "TinEye-bot-live",
        "Tiny Tiny RSS",
        "Titan",
        "Toata",
        "Toweyabot",
        "Tracemyfile",
        "Traackr.com",
        "Trendiction",
        "Trendiction.com",
        "Trendiction.de",
        "Trendictionbot",
        "TrendsmapResolver",
        "True_Robot",
        "Turingos",
        "Turnitin",
        "TurnitinBot",
        "TwengaBot",
        "Twice",
        "TweetedTimes Bot",
        "Tweetedtimes",
        "TweetmemeBot",
        "Twingly",
        "TwitterFeed",
        "Twitterbot",
        "Typhoeus",
        "URLy Warning",
        "URLy.Warning",
        "Ubermetrics",
        "Ubermetrics-technologies.com",
        "UnisterBot",
        "UnwindFetchor",
        "Upflow",
        "Updown_tester",
        "Urlresolver",
        "V-BOT",
        "VB Project",
        "VCI",
        "Vacuum",
        "Vagabondo",
        "VegeBot",
        "VelenPublicWebCrawler",
        "VelenPublicWebCrawler/1.0",
        "VeriCiteCrawler",
        "VidibleScraper",
        "Virusdie",
        "Voil",
        "VoidEYE",
        "Voltron",
        "Voyagerx.com",
        "WASALive-Bot",
        "WBSearchBot",
        "WEBDAV",
        "WISENutbot",
        "WPScan",
        "WWW-Collector-E",
        "WWW-Mechanize",
        "WWWOFFLE",
        "Wallpapers",
        "Wallpapers/3.0",
        "WallpapersHD",
        "WeSEE",
        "Web Auto",
        "WebBandit",
        "WebCollage",
        "WebCopier",
        "WebEnhancer",
        "WebFetch",
        "WebFuck",
        "WebGo IS",
        "WebImageCollector",
        "WebLeacher",
        "WebPix",
        "WebReaper",
        "WebSauger",
        "WebStripper",
        "WebSucker",
        "WebWhacker",
        "WebZIP",
        "Webalta",
        "Webdatastats.com",
        "WebmasterWorldForumBot",
        "Webshag",
        "WebsiteExtractor",
        "Website Quester",
        "Webster",
        "WellKnownBot",
        "Whack",
        "Whacker",
        "Whatweb",
        "Who.is Bot",
        "Widow",
        "WinHTTrack",
        "WiseGuys Robot",
        "Wonderbot",
        "Woobot",
        "WordPress.com mShots",
        "Wotbox",
        "Wprecon",
        "Xaldon WebSpider",
        "Xaldon_WebSpider",
        "XenForo",
        "Xenu",
        "XoviBot",
        "Y!J-BRW",
        "YaK/1.0",
        "Yahoo Ad monitoring",
        "Yahoo! Slurp",
        "YandexBot",
        "Yeti",
        "YisouSpider",
        "YoudaoBot",
        "Zade",
        "Zauba",
        "Zermelo",
        "Zeus",
        "Zitebot",
        "ZmEu",
        "ZoomBot",
        "ZoominfoBot",
        "ZumBot",
        "ZyBorg",
        "acebookexternalhit",
        "admantx-adform",
        "adscanner",
        "aiohttp",
        "arquivo.pt",
        "autoemailspider",
        "backlink-check",
        "baidu",
        "bingbot",
        "cah.io.community",
        "check1.exe",
        "clark-crawler",
        "coccocbot",
        "cognitiveseo",
        "commoncrawl",
        "cs.daum.net",
        "curl/7",
        "dataforseo.com",
        "domainappender",
        "domainsproject.org",
        "ecatch",
        "evc-batch",
        "facebookexternalhit",
        "facebookscraper",
        "feedbot",
        "genieo",
        "getstream.io/winds",
        "glutenfreepleasure.com",
        "gopher",
        "ia_archiver",
        "iaskspider",
        "ibwww-perl",
        "imagesift",
        "instabid",
        "internetVista monitor",
        "ips-agent",
        "isitwp.com",
        "iubenda-radar",
        "lwp-request",
        "lwp-trivial",
        "majestic12",
        "meanpathbot",
        "mediawords",
        "metadataparser",
        "metauri",
        "mon.itor.us",
        "muhstik-scan",
        "newspaper",
        "newsblur",
        "nutch",
        "obot",
        "okhttp",
        "page scorer",
        "pcbrowser",
        "plumanalytics",
        "polaris version",
        "probe-image-size",
        "profound",
        "proximic",
        "ripz",
        "rogerbot-crawler",
        "rss-is-dead",
        "s1z.ru",
        "satoristudio.net",
        "scan.lol",
        "schmorp.de",
        "seobility",
        "seocompany.store",
        "seoscanners",
        "seostar",
        "serpstatbot",
        "sexsearcher",
        "sindresorhus/got",
        "sitechecker.pro",
        "siteripz",
        "slackbot",
        "sogouspider",
        "sp_auditbot",
        "spbot",
        "spyfu",
        "sqlmap",
        "superfeedr",
        "sysscan",
        "takeout",
        "terrykyleseoagency.com",
        "trendiction.com",
        "trendiction.de",
        "tweetedtimes",
        "twingly",
        "ubermetrics-technologies.com",
        "updown_tester",
        "urlresolver",
        "voyagerx.com",
        "webdatastats.com",
        "webgains-bot",
        "webmeup-crawler",
        "webpros.com",
        "webprosbot",
        "whatsapp",
        "x09mozilla",
        "x22mozilla",
        "xpymep1.exe",
        "yacybot",
        "yahoo! slurp",
        "yahoo ad monitoring",
        "zauba.io",
        "zgrab",
        "zombiebot"
    ];
    foreach ($bots as $bot) {
        if (stripos($_SERVER['HTTP_USER_AGENT'], $bot) !== false)
            return true;
    }
    return false;
}


// mode
const DEFAULT_MODE = 'development';
define('MODE', isset($_GET['m']) ? trim(rawurldecode($_GET['m'])) : DEFAULT_MODE);
include_once __DIR__ . '/constants.' . DEFAULT_MODE . '.php';


// cors
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    header("Access-Control-Allow-Origin: *");
    header("Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS");
    header("Access-Control-Allow-Headers: {$_SERVER['HTTP_ACCESS_CONTROL_REQUEST_HEADERS']}");
    header("Access-Control-Max-Age: 1728000");
    header("Content-Length: 0");
    header("Content-Type: text/plain");
    exit(0);
}
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Credentials: true");
header("Content-Type: application/json");


// datetime
define('LOCALE', 'fr_FR.UTF-8');
setlocale(LC_ALL, LOCALE);
define('TIMEZONE', 'Europe/Paris');
date_default_timezone_set(TIMEZONE);
define('NOW', (new \DateTime('now', new \DateTimeZone('UTC'))));
define('NOW_TIMESTAMP', NOW->getTimestamp());


// client infos
define('CLIENT_IP', $_SERVER['HTTP_CLIENT_IP'] ?? ($_SERVER['HTTP_X_FORWARDED_FOR'] ?? $_SERVER['REMOTE_ADDR']));
define('CLIENT_TYPE', is_bot() ? 'bot' : 'user');
define('CLIENT_FROM_LOCALHOST', CLIENT_IP === '127.0.0.1' || CLIENT_IP === '::1');


// referer
define('REFERER', stripslashes($_SERVER['HTTP_REFERER'] ?? ''));
if (MODE !== 'development') {
    $hostIsAllowed = in_array(true, array_map(fn($allowedHost) => stripos(REFERER, $allowedHost, 0) !== false, [
        'localhost',
        '127.0.0.1',
        'www.tiquettes.fr'
    ]));
    if (!$hostIsAllowed) {
        header("HTTP/1.1 401 Unauthorized");
        exit(0);
    }
}


// database
try {
    $pdo = new PDO("mysql:host=" . MYSQL_HOST . ";port=" . MYSQL_PORT . ";dbname=" . MYSQL_BASE, MYSQL_USER, MYSQL_PASS);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    define('DB', $pdo);
} catch (PDOException $e) {
    dd_json($e);
    exit(0);
}
